<template>
  <div class="container-fluid vh-100 max-vh-100">
    <div class="row h-100">
      <Sidebar @create="create" :first-image="firstImage" :creating-image="creatingImage" :link="link" />
      <main
        class="col d-flex flex-column align-items-center justify-content-center"
      >
        <img :src="link" />
        <span>{{ prompt }}</span>
      </main>
    </div>
  </div>
</template>

<script setup>
const ORIGINAL_IMAGE =
  "/img/DALLÂ·E 2022-11-11 14.24.43 - Marlon Brando eating soup on the beach in the style of van Gogh.png";
const link = ref(ORIGINAL_IMAGE);

const prompt = ref(
  "Marlon Brando eating soup on the beach in the style of van Gogh"
);
const creatingImage = ref(false);

const firstImage = computed(() => {
  return link.value === ORIGINAL_IMAGE;
});

async function create(object, action, location, style) {
  if (!object || !action || !location) {
    alert("Please fill in the form");
    return;
  }

  creatingImage.value = true;

  const newPrompt = createPrompt(object, action, location, style);

  const moderationResults = await moderateInput(newPrompt);

  if (moderationResults.flagged) {
    const flaggedCategories = Object.entries(moderationResults.categories)
      .filter(([category, flagged]) => flagged === true)
      .map(([category, flagged]) => category);

    alert(
      "This prompt is not allowed because it contains: " +
        flaggedCategories.join(", ")
    );

    creatingImage.value = false;
    return;
  }

  link.value = "/img/bars.svg";

  const imageUrl = await getImageUrl(newPrompt);
  console.log(imageUrl);

  link.value = imageUrl;
  prompt.value = newPrompt;
  creatingImage.value = false;
}

function createPrompt(object, action, location, style) {
  return (
    object +
    " " +
    action +
    " " +
    location +
    (style ? " in the style of " + style : "")
  );
}

async function moderateInput(input) {
  return $fetch("/api/moderate", {
    method: "POST",
    body: JSON.stringify({
      input,
    }),
  });
}

async function getImageUrl(prompt) {
  return $fetch("/api/image", {
    method: "POST",
    body: JSON.stringify({
      prompt,
    }),
  });
}
</script>

<style scoped>
img {
  height: 75vh;
}
</style>
